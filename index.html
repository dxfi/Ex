<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minting History</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <!-- Link ke CSS eksternal -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div>
        <h1>Minting History</h1>
        <div id="historyContainer"></div>
    </div>

    <script>
        // URL RPC jaringan (ganti dengan RPC jaringan Anda, misalnya dari Infura atau Alchemy)
        const RPC_URL = "https://opbnb-testnet-rpc.bnbchain.org"; // Ganti dengan RPC Anda
        const web3 = new Web3(new Web3.providers.HttpProvider(RPC_URL));

        // Alamat kontrak Anda
        const CONTRACT_ADDRESS = "0x1234567890abcdef1234567890abcdef12345678"; // Ganti dengan alamat kontrak Anda

        // ABI kontrak Anda
        const CONTRACT_ABI = [
            {
                "anonymous": false,
                "inputs": [
                    { "indexed": true, "internalType": "address", "name": "from", "type": "address" },
                    { "indexed": true, "internalType": "address", "name": "to", "type": "address" },
                    { "indexed": false, "internalType": "uint256", "name": "value", "type": "uint256" }
                ],
                "name": "Transfer",
                "type": "event"
            }
        ];

        // Inisialisasi kontrak
        const contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);

        // Fungsi untuk menghitung waktu relatif (misalnya "2 minutes ago")
        function formatTimeAgo(timestamp) {
            const now = Date.now() / 1000; // Waktu sekarang dalam detik
            const secondsAgo = now - timestamp;

            const minutes = Math.floor(secondsAgo / 60);
            const hours = Math.floor(secondsAgo / 3600);
            const days = Math.floor(secondsAgo / 86400);

            if (secondsAgo < 60) {
                return "Just now";
            } else if (minutes < 60) {
                return `${minutes} minute(s) ago`;
            } else if (hours < 24) {
                return `${hours} hour(s) ago`;
            } else {
                return `${days} day(s) ago`;
            }
        }

        // Fungsi untuk memperpendek txid dan alamat
        function shortenTxid(txid) {
            return `${txid.substring(0, 10)}...${txid.substring(txid.length - 10)}`;
        }

        function shortenAddress(address) {
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        }

        // Fungsi untuk mengambil riwayat minting
        async function fetchMintingHistory() {
            try {
                // Ambil semua event Transfer dari blok awal sampai blok terbaru
                const events = await contract.getPastEvents('Transfer', {
                    fromBlock: 0, // Mulai dari blok genesis
                    toBlock: 'latest' // Sampai blok terakhir
                });

                console.log("Riwayat Minting (Transfer Events):", events);

                // Format data event untuk ditampilkan
                const formattedEvents = events.map(event => ({
                    from: event.returnValues.from,
                    to: event.returnValues.to,
                    value: web3.utils.fromWei(event.returnValues.value, 'ether'), // Konversi ke Ether
                    blockNumber: event.blockNumber,
                    transactionHash: event.transactionHash,
                    timestamp: event.returnValues.timestamp || Date.utc() // Ambil timestamp dari event atau gunakan waktu sekarang
                }));

                // Tampilkan data di konsol
                console.table(formattedEvents);

                // Jika ingin menampilkan di UI, gunakan DOM
                const historyContainer = document.getElementById("historyContainer");
                if (historyContainer) {
                    historyContainer.innerHTML = formattedEvents.map(event => `
                        <div class="event">
                            <p><strong>Transaction:</strong> <a href="https://opbnb-testnet.bscscan.com/tx/${event.transactionHash}" target="_blank">${shortenTxid(event.transactionHash)}</a></p>
                            <p><strong>Block:</strong> ${event.blockNumber}</p>
                            <p><strong>Wallet:</strong> ${shortenAddress(event.to)}</p>
                            <p><strong>Minting. . . . .</strong></p>
                            <p><strong>Amount:</strong> ${event.value} AI</p>
                            <p><strong>Time:</strong> ${event.timestamp}</p> <!-- Menampilkan timestamp dalam format UTC -->
                        </div>
                        <hr>
                    `).join("");
                }
            } catch (error) {
                console.error("Error fetching minting history:", error);
            }
        }

        // Panggil fungsi untuk mengambil riwayat minting pertama kali
        fetchMintingHistory();

        // Set interval untuk refresh riwayat minting setiap 1 detik (1000 ms)
        setInterval(fetchMintingHistory, 1000); // Interval dalam milidetik
    </script>
</body>
</html>
